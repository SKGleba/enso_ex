#define CEX 0x0301 // retail
#define DEX 0x0201 // testkit
#define DEVTOOL 0x0101 // devkit
#define TEST 0x0001 // system debugger (internal)

// patch re-write keyslot 0x509 patching device type
static const unsigned char dex_patch_nmp[] = {
  0x21, 0xc3, 0x06, 0xe0, 0x34, 0xc3, 0x24, 0x21, 0xe0, 0x6f, 0x3e, 0x03,
  0x06, 0x43, 0x21, 0xc3, 0x06, 0xe0, 0x34, 0xc3, 0x20, 0x21, 0xf9, 0xc1,
  0x04, 0x00, 0x3e, 0x02, 0x21, 0xc3, 0x03, 0xe0, 0x3a, 0x02, 0x07, 0x42,
  0x34, 0xc3, 0x04, 0x00, 0x20, 0x6f, 0x3a, 0x02, 0x21, 0xc3, 0x06, 0xe0,
  0x34, 0xc3, 0x28, 0x21, 0x3e, 0x02, 0x21, 0xc3, 0x03, 0xe0, 0x34, 0xc3,
  0x08, 0x00, 0x3a, 0x02, 0x21, 0xc3, 0x06, 0xe0, 0x34, 0xc3, 0x2c, 0x21,
  0x3e, 0x02, 0x21, 0xc3, 0x03, 0xe0, 0x34, 0xc3, 0x0c, 0x00, 0x3a, 0x02,
  0x21, 0xc3, 0x06, 0xe0, 0x34, 0xc3, 0x30, 0x21, 0x3e, 0x02, 0x21, 0xc3,
  0x03, 0xe0, 0x34, 0xc3, 0x10, 0x00, 0x3a, 0x02, 0x21, 0xc3, 0x06, 0xe0,
  0x34, 0xc3, 0x34, 0x21, 0x3e, 0x02, 0x21, 0xc3, 0x03, 0xe0, 0x34, 0xc3,
  0x14, 0x00, 0x3a, 0x02, 0x21, 0xc3, 0x06, 0xe0, 0x34, 0xc3, 0x38, 0x21,
  0x3e, 0x02, 0x21, 0xc3, 0x03, 0xe0, 0x34, 0xc3, 0x18, 0x00, 0x3a, 0x02,
  0x21, 0xc3, 0x06, 0xe0, 0x34, 0xc3, 0x3c, 0x21, 0x3e, 0x02, 0x21, 0xc3,
  0x03, 0xe0, 0x34, 0xc3, 0x1c, 0x00, 0x3a, 0x02, 0x21, 0xc3, 0x03, 0xe0,
  0x34, 0xc3, 0x20, 0x00, 0x01, 0xc2, 0x09, 0x05, 0x3a, 0x02, 0x02, 0x70,
  0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x1f, 0x00
};

__attribute__((optimize("O0"))) int set_type(uint16_t stype) {
	char backup[0x80];
	memcpy(&backup, payload_block_addr, 0x80);
	memset(payload_block_addr, 0, 0x200);
	
	memcpy((payload_block_addr + 0x40), &dex_patch_nmp, sizeof(dex_patch_nmp));
	
	fm_nfo *fmnfo = payload_block_addr;
	fmnfo->magic = 0x14FF;
	fmnfo->status = 0x34;
	fmnfo->codepaddr = 0x1f850040;
	fmnfo->arg = (uint16_t)stype;
	
	smc_custom(0, 0, 0, 0, 0x13c); // run custom code
	
	int ret = (fmnfo->status == 0x69) ? (int)fmnfo->resp : -1;
	
	memcpy(payload_block_addr, &backup, 0x80);
	
	*(uint16_t *)(boot_args + 0xA2) = (uint16_t)stype; // update enso's KBL_PARAM.DTYPE for patches compat
	*(uint16_t *)((*(uint32_t *)(*(uint32_t *)(0x51138a3c) + 0x6c)) + 0xA2) = (uint16_t)stype; // update sysrootNP2->KBL_PARAM.DTYPE to bypass mismatch
	
	return ret;
}